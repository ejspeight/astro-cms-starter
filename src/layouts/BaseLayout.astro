---
/**
 * BaseLayout — Root layout used by every page on the site.
 *
 * Responsibilities:
 * - HTML boilerplate and <head> with SEO meta tags
 * - Global CSS import (Tailwind + brand theme)
 * - Open Graph / social meta tags
 * - Slot for page-specific content
 *
 * Usage:
 *   <BaseLayout title="Home" description="Welcome to our gym">
 *     <main>...</main>
 *   </BaseLayout>
 */

import "../styles/global.css";
import { site } from "../config/site";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";

interface Props {
    /** Page title — inserted into the site.seo.titleTemplate */
    title: string;
    /** Meta description for SEO. Falls back to site.description */
    description?: string;
    /** Open Graph image URL. Falls back to site.seo.defaultImage */
    ogImage?: string;
    /** Optional canonical URL override */
    canonicalUrl?: string;
    /** If true, robots will not index this page */
    noindex?: boolean;
}

const {
    title,
    description = site.description,
    ogImage = site.seo.defaultImage,
    canonicalUrl,
    noindex = false,
} = Astro.props;

// Build the full page title using the template from site config
const fullTitle = site.seo.titleTemplate.replace("%s", title);

// Analytics — loaded only when env vars are set (see .env.example)
// Prefer GTM when both are present; GTM can bundle GA inside the container.
const gtmId = import.meta.env.PUBLIC_GTM_ID; // e.g. GTM-XXXXXXX
const gaId = import.meta.env.PUBLIC_GA_ID; // e.g. G-XXXXXXXXXX

// Resolve canonical URL — use override or derive from current page path
const canonical = canonicalUrl ?? new URL(Astro.url.pathname, site.url).href;

// Resolve OG image to absolute URL
const absoluteOgImage = ogImage?.startsWith("http")
    ? ogImage
    : new URL(ogImage ?? "", site.url).href;
---

<!doctype html>
<html lang={site.language} class="scroll-smooth">
    <head>
        <!-- Core meta -->
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content={Astro.generator} />

        <!-- SEO -->
        <title>{fullTitle}</title>
        <meta name="description" content={description} />
        <link rel="canonical" href={canonical} />
        {noindex && <meta name="robots" content="noindex, nofollow" />}

        <!-- Open Graph -->
        <meta property="og:type" content="website" />
        <meta property="og:title" content={fullTitle} />
        <meta property="og:description" content={description} />
        <meta property="og:url" content={canonical} />
        <meta property="og:image" content={absoluteOgImage} />
        <meta property="og:site_name" content={site.name} />

        <!-- Twitter Card -->
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:title" content={fullTitle} />
        <meta name="twitter:description" content={description} />
        <meta name="twitter:image" content={absoluteOgImage} />
        {
            site.seo.twitterHandle && (
                <meta name="twitter:site" content={site.seo.twitterHandle} />
            )
        }

        <!-- RSS Feed auto-discovery -->
        <link
            rel="alternate"
            type="application/rss+xml"
            title={`${site.name} Blog`}
            href="/rss.xml"
        />

        <!-- Favicons & Web Manifest -->
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <link rel="icon" href="/favicon.ico" sizes="32x32" />
        <link rel="apple-touch-icon" href="/favicon.svg" />
        <link rel="manifest" href="/site.webmanifest" />

        <!--
      Theme colour for mobile browsers — reads from the CSS variable set in
      global.css so there's only one place to update brand colours.
      The inline script runs immediately and sets the meta tag content.
    -->
        <meta name="theme-color" content="#1e40af" id="theme-color-meta" />
        <script is:inline>
            (function () {
                var primary = getComputedStyle(document.documentElement)
                    .getPropertyValue("--color-primary")
                    .trim();
                if (primary) {
                    var meta = document.getElementById("theme-color-meta");
                    if (meta) meta.setAttribute("content", primary);
                }
            })();
        </script>

        <!--
      Web fonts: If you switch from system fonts to a hosted font (e.g. Google
      Fonts), add the <link> or @font-face import here. Update the font family
      in the @theme block of src/styles/global.css to match.
    -->

        <!-- Netlify Identity widget — required for Decap CMS authentication -->
        <script
            is:inline
            src="https://identity.netlify.com/v1/netlify-identity-widget.js"
        ></script>

        <!--
      Analytics — inject GTM or GA4 when the corresponding env var is set.
      Set PUBLIC_GTM_ID=GTM-XXXXXXX or PUBLIC_GA_ID=G-XXXXXXXXXX in your
      .env file (or Netlify environment variables). Neither loads if unset.
      GTM takes precedence — manage GA inside the GTM container instead.
    -->
        {gtmId && (
            <script is:inline define:vars={{ gtmId }}>
                (function (w, d, s, l, i) {
                    w[l] = w[l] || [];
                    w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
                    var f = d.getElementsByTagName(s)[0],
                        j = d.createElement(s),
                        dl = l != "dataLayer" ? "&l=" + l : "";
                    j.async = true;
                    j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
                    f.parentNode.insertBefore(j, f);
                })(window, document, "script", "dataLayer", gtmId);
            </script>
        )}
        {!gtmId && gaId && (
            <>
                <script
                    is:inline
                    define:vars={{ gaId }}
                    src={`https://www.googletagmanager.com/gtag/js?id=${gaId}`}
                    async
                ></script>
                <script is:inline define:vars={{ gaId }}>
                    window.dataLayer = window.dataLayer || [];
                    function gtag() {
                        dataLayer.push(arguments);
                    }
                    gtag("js", new Date());
                    gtag("config", gaId);
                </script>
            </>
        )}
    </head>

    <body
        class="min-h-screen flex flex-col bg-accent text-text-body font-body antialiased"
    >
        <!-- GTM noscript fallback — required by GTM, no-op without a GTM ID -->
        {gtmId && (
            <noscript>
                <iframe
                    src={`https://www.googletagmanager.com/ns.html?id=${gtmId}`}
                    height="0"
                    width="0"
                    style="display:none;visibility:hidden"
                ></iframe>
            </noscript>
        )}

        <!-- Skip to content link — visible on focus for keyboard/screen reader users -->
        <a
            href="#main-content"
            class="sr-only focus:not-sr-only focus:fixed focus:top-2 focus:left-2 focus:z-[100]
                   focus:bg-primary focus:text-white focus:px-4 focus:py-2 focus:rounded-md focus:text-sm focus:font-semibold"
        >
            Skip to content
        </a>

        <Header />

        <!-- Page content -->
        <div id="main-content">
            <slot />
        </div>

        <Footer />

        <!--
      Netlify Identity redirect handler — after login, redirect the user
      back to the /admin/ CMS panel. This script must be on every page
      so the OAuth redirect works regardless of which page the user lands on.
    -->
        <script is:inline>
            if (window.netlifyIdentity) {
                window.netlifyIdentity.on("init", (user) => {
                    if (!user) {
                        window.netlifyIdentity.on("login", () => {
                            document.location.href = "/admin/";
                        });
                    }
                });
            }
        </script>
    </body>
</html>
